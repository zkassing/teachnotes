[TOC]

## 一、什么是跨域

![url的组成](assets/1638b3579d9eeb32)

**JavaScript 出于安全方面的考虑，不允许跨域调用其他页面的对象。**

那什么是跨域呢，简单地理解就是

> 因为 JavaScript 同源策略的限制，a.com 域名下的 js 无法操作 b.com 或是 c.a.com 域名下的对象。

**当协议、子域名、主域名、端口号中任意一个不相同时，都算作不同域**。

不同域之间相互请求资源，就算作“跨域”。

例如：[www.abc.com/index.html]() 请求 [www.efg.com/service.php…]()

有一点必须要注意：

> **跨域并不是请求发不出去，请求能发出去，服务端能收到请求并正常返回结果，只是结果被浏览器拦截了**。

之所以会跨域，是因为受到了同源策略的限制，同源策略要求源相同才能正常进行通信，即协议、域名、端口号都完全一致。

大家可以参照下图，有助于深入理解跨域。

![img](assets/1638b3579dde630e)

特别说明两点：

**第一：如果是协议和端口造成的跨域问题“前台”是无能为力的。**

**第二：在跨域问题上，域仅仅是通过“URL 的首部”来识别而不会根据域名对应的 IP 地址是否相同来判断。“URL 的首部”可以理解为“协议, 域名和端口必须匹配”**。

## 二、什么是同源策略及其限制

同源策略限制从一个源加载的文档或脚本如何与来自另一个源的资源进行交互。
这是一个用于隔离潜在恶意文件的关键的安全机制。
> **它的存在可以保护用户隐私信息，防止身份伪造等(读取 Cookie)。**

**同源策略限制内容有：**

-   Cookie、LocalStorage、IndexedDB 等存储性内容
-   DOM 节点
-   AJAX 请求不能发送

**但是有三个标签是允许跨域加载资源：**

1. `<img src=XXX>`
2. `<link href=XXX>`
3. `<script src=XXX>`

> 所有的跨域都必须经过信息提供方的允许。如果未经允许即可获取，那是浏览器同源策略出现漏洞。

## 三、处理跨域方法一 —— `JSONP`

#### 1. JSONP 原理

利用 `<script>`元素的这个开放策略，网页可以得到从其他来源动态产生的 JSON 数据。JSONP 请求一定需要对方的服务器做支持才可以。

#### 2. JSONP 和 AJAX 对比

JSONP 和 AJAX 相同，都是客户端向服务器端发送请求，从服务器端获取数据的方式。但 AJAX 属于同源策略，JSONP 属于非同源策略（跨域请求）

#### 3. JSONP 优缺点

JSONP 优点是兼容性好，可用于解决主流浏览器的跨域数据访问的问题。**缺点是仅支持 get 方法具有局限性。**

## 四、处理跨域方法二 —— `CORS`

#### 1. CORS 原理

CORS 是一个 W3C 标准，全称是"跨域资源共享"（`Cross-origin resource sharing`）。

它允许浏览器向跨源服务器，发出 `XMLHttpRequest` 请求，从而克服了 AJAX 只能同源使用的限制

整个 CORS 通信过程，都是浏览器自动完成，不需要用户参与。对于开发者来说，CORS 通信与同源的 AJAX 通信没有差别，代码完全一样。浏览器一旦发现 AJAX 请求跨源，就会自动添加一些附加的头信息，有时还会多出一次附加的请求，但用户不会有感觉。
> **因此，实现 CORS 通信的关键是服务器。只要服务器实现了 CORS 接口，就可以跨源通信**。

#### 2. CORS 优缺点

> **CORS 要求浏览器(>IE10)和服务器的同时支持，是跨域的根本解决方法，由浏览器自动完成**。
优点在于功能更加强大支持各种 HTTP Method，缺点是兼容性不如 JSONP。

只需要在服务器端做一些小小的改造即可：

```php
header("Access-Control-Allow-Origin:*"); // 可以跨域的域名, 写*代表所有
header("Access-Control-Allow-Methods:POST,GET"); // 可以跨域的方法
header('Access-Control-Allow-Headers: Origin, X-Requested-With, Content-Type, Accept'); // 可以不加
```

```php
header('Access-Control-Allow-Origin: http://www.sina-show.com'); // 可以跨域的域名, 可以固定的
header("Access-Control-Allow-Methods:POST,GET"); // 可以跨域的方法
header('Access-Control-Allow-Headers: Origin, X-Requested-With, Content-Type, Accept'); // 可以不加
```


在响应头上添加 Access-Control-Allow-Origin 属性，指定同源策略的地址。同源策略默认地址是网页的本身。
> **只要浏览器检测到响应头带上了 CORS，并且允许的源包括了本网站，那么就不会拦截请求响应**。

![img](assets/163ab950d32aa265)

![img](assets/4248565459-5a37337dc63eb.png)
